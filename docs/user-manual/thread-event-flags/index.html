<!doctype html>

<html lang="en">


<head>

  <meta charset='utf-8'>
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <title>Thread event flags</title>
  <meta name="description" content="A POSIX inspired open source framework, written in C++.">

  <meta property="og:title" content="Thread event flags" />
  <meta property="og:site_name" content="µOS++" />

  <link rel="alternate" type="application/rss+xml" title="µOS++" href="/feed.xml" />


  <meta property="article:published_time" content="2016-07-08">





  <meta name="google-site-verification" content="NT_y3tqI_8mrd8gYA_FDWHT2-tkJExOC6KBkSnyZx6c" />

  <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" type="text/css" href="/stylesheets/screen.css?202305210532" media="screen">
  <link rel="stylesheet" type="text/css" href="/stylesheets/font-awesome.css?202305210532" media="screen">
  <link rel="stylesheet" type="text/css" href="/stylesheets/print.css?202305210532" media="print">

  <link rel="canonical" href="/user-manual/thread-event-flags/">



  <!--[if lt IE 9]>
  <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->


<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-E9T84WD3CK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E9T84WD3CK');
</script>



</head>


<body>

<div class="container">

  <div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.4";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

  <script>window.twttr = (function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0],
    t = window.twttr || {};
  if (d.getElementById(id)) return t;
  js = d.createElement(s);
  js.id = id;
  js.src = "https://platform.twitter.com/widgets.js";
  fjs.parentNode.insertBefore(js, fjs);

  t._e = [];
  t.ready = function(f) {
    t._e.push(f);
  };

  return t;
}(document, "script", "twitter-wjs"));</script>

  <div class="site-header">
  <table style="width:100%">
    <tr>
      <td>
        <a href="/">
          <img alt="Icon" class="site-icon" src="/assets/icons/wall-e-icon.png" height="100" width="100">
      </a>
      </td>
      <td>
        <table class="site-title" style="width:100%">
          <tr>
            <td class="site-title">
              <a href="/">µOS++</a>
            </td>
            <td class="site-motto" align="right">
              “Perfekt ist nicht gut genug”
            </td>
          </tr>
          <tr>
            <td class="site-description" colspan="2">
              A POSIX inspired open source framework, written in C++.
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</div>


</div>

<div class="container">

  <div class="wrapper">
    <div class="site-body">

      <div class="site-sidebar">


  <div class="custom-sidebar">
    <div class="boxed-group-inner">
      <h4 id="news"><a href="/blog/">News</a></h4>

<ul>
  <li><a href="/blog/2023/07/19/micro-os-plus-v7-0-0-released/">µOS++ v7.0.0 released</a></li>
  <li><a href="/blog/2021/05/21/micro-os-plus-v6-3-17-released/">µOS++ v6.3.17 released</a></li>
  <li><a href="/blog/2021/05/03/micro-os-plus-v6-3-16-released/">µOS++ v6.3.16 released</a></li>
  <li><a href="/blog/2021/01/22/micro-os-plus-first-scriptable-build/">First µOS++ scriptable build</a></li>
</ul>


    </div>
  </div>


  <div class="custom-sidebar">
    <div class="boxed-group-inner">
      
      <h4 id="home"><a href="/">Home</a></h4>

<h4 id="µos">µOS++</h4>

<ul>
  <li><a href="/micro-os-plus/">Overview</a></li>
  <li><a href="/micro-os-plus/iii/releases/">Releases</a></li>
</ul>

<h4 id="apis">APIs</h4>

<ul>
  <li><a href="/cmsis-plus/">Overview</a></li>
  <li><a href="/cmsis-plus/rtos/">RTOS API</a></li>
</ul>

<h4 id="xpacks">xPacks</h4>

<ul>
  <li><a href="/xpacks/">Overview</a></li>
</ul>

<h4 id="documentation">Documentation</h4>

<ul>
  <li>
<a href="/user-manual/">User’s <strong>manual</strong></a>
    <ul>
      <li><a href="/user-manual/getting-started/">Getting started</a></li>
      <li><a href="/user-manual/basic-concepts/">Basic concepts</a></li>
      <li><a href="/user-manual/features/">Features</a></li>
      <li><a href="/user-manual/threads/">Threads</a></li>
      <li><a href="/user-manual/thread-event-flags/">Thread event flags</a></li>
      <li><a href="/user-manual/semaphores/">Semaphores</a></li>
      <li><a href="/user-manual/event-flags/">Event flags</a></li>
      <li>Mutexes</li>
      <li>Condition variables</li>
      <li>Message queues</li>
      <li>Memory pools</li>
      <li>Software timers</li>
      <li>Clocks</li>
    </ul>
  </li>
  <li><a href="/reference/cmsis-plus/">µOS++ <strong>reference</strong></a></li>
</ul>

<h4 id="developer">Developer</h4>

<ul>
  <li><a href="/develop/">Overview</a></li>
  <li><a href="/reference/cmsis-plus/md_doxygen_pages_change-log.html">Change log</a></li>
  <li><a href="/develop/coding-style/">C++ coding style</a></li>
  <li><a href="/develop/naming-conventions/">Naming conventions</a></li>
  <li><a href="/develop/references/">Links &amp; references</a></li>
</ul>

<h4 id="support">Support</h4>

<ul>
  <li><a href="/support/">Overview</a></li>
  <li><a href="/support/known-issues/">Known issues</a></li>
  <li><a href="/support/faq/">FAQ</a></li>
  <li><a href="/support/forum/">Forum</a></li>
  <li><a href="https://github.com/micro-os-plus/micro-os-plus-iii/issues/">Report µOS++ issues</a></li>
</ul>

<h4 id="latest-articles">Latest Articles</h4>

<ul>
  <li><a href="/articles/arm-com-2016-06-24/">CMSIS++ RTOS: fully functional reference implementation</a></li>
  <li><a href="/articles/arm-com-2016-03-11/">CMSIS++: a proposal for a future CMSIS, written in C++</a></li>
</ul>

<h4 id="project">Project</h4>

<ul>
  <li><a href="/project/about/">About</a></li>
  <li><a href="/project/history/">History</a></li>
  <li><a href="https://opensource.org/licenses/MIT">License (MIT)</a></li>
</ul>

    </div>
  </div>

  <div class="site-theme">
    This site uses the <a href="https://github.com/ilg-ul/github-jekyll-theme">GitHub Wiki-like</a> theme by <a href="https://github.com/ilg-ul">Liviu Ionescu</a>.
  </div>

</div>


      <div class="site-content">

        
<h1 class="page-title">Thread event flags</h1>
<table id="last-modified">
  <tr>
    <td id="last-modified">Last modified on Wed Jul 19 11:46:15 2023 UTC.</td>
    <td id="improve" align="right"><a id="improve" href="https://github.com/micro-os-plus/web-jekyll/edit/master/pages/user-manual/thread-event-flags.md"><i class="fa fa-pencil"></i>  Improve this page</a></td>
  </tr>
</table>

<h2 id="overview">Overview</h2>

<p>Traditionally, one of the first inter-process communication methods provided by Unix was sending signals from one process to another. Although limited, this method still has its benefits, and all later POSIX systems preserved and enhanced it.</p>

<p>However, for embedded systems, the implementation is a bit too heavy, and, for the moment, was not considered appropriate.</p>

<p>Instead, a light mechanism was adopted, the thread event flags, very similar to the generic event flags, but specific to each thread.</p>

<p>This mechanism provides a number of separate flags for each thread, that can be raised by other threads or ISRs, and can be checked by the owner thread in various ways, including with blocked waits on multiple flags.</p>

<p>Each such event flag can be considered as a simplified binary semaphore, that can be posted from outside and the thread can wait for it.</p>

<h2 id="raising-thread-event-flags">Raising thread event flags</h2>

<p>As long as the thread identity is known, any other thread or ISR can raise any set of flags, at any time.</p>

<p>In programming language terms, raising flags is equivalent to OR-ing the corresponding bits in the thread event flags mask. Once raised, the flag remains raised until it is checked by the thread, or explicitly cleared by the thread. Raising an already raised flag is a no-op.</p>

<p>If the thread was suspended and waits for flags, it is resumed.</p>

<h2 id="waiting-for-thread-event-flags">Waiting for thread event flags</h2>

<p>A thread can check at any time if an expected set of flags are raised; it is possible to check if all flags in a set are raised, or if any flag in a set is raised.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">/// @file app-main.cpp</span>
<span class="cp">#include &lt;cmsis-plus/rtos/os.h&gt;
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">os</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">os</span><span class="o">::</span><span class="n">rtos</span><span class="p">;</span>

<span class="c1">// Thread function.</span>
<span class="kt">void</span><span class="o">*</span>
<span class="nf">th_func</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// Wait for two event flags.</span>
  <span class="n">result_t</span> <span class="n">res</span><span class="p">;</span>
  <span class="n">res</span> <span class="o">=</span> <span class="n">this_thread</span><span class="o">::</span><span class="n">flags_timed_wait</span><span class="p">(</span><span class="mh">0x3</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">os_ok</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">trace</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="s">"Both flags raised</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">ETIMEDOUT</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">trace</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="s">"Timeout</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="k">return</span> <span class="nb">nullptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">os_main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="c1">// ...</span>

  <span class="c1">// Create the thread. Stack is dynamically allocated.</span>
  <span class="kr">thread</span> <span class="n">th</span> <span class="p">{</span> <span class="s">"th"</span><span class="p">,</span> <span class="n">th_func</span><span class="p">,</span> <span class="nb">nullptr</span> <span class="p">};</span>

  <span class="c1">// Raise one flag. The condition is not enough to resume the thread.</span>
  <span class="n">th</span><span class="p">.</span><span class="n">flags_raise</span><span class="p">(</span><span class="mh">0x1</span><span class="p">);</span>

  <span class="c1">// Pretend the thread has something important to do.</span>
  <span class="n">sysclock</span><span class="p">.</span><span class="n">sleep_for</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

  <span class="c1">// Raise second flag. The thread will be resumed.</span>
  <span class="n">th</span><span class="p">.</span><span class="n">flags_raise</span><span class="p">(</span><span class="mh">0x2</span><span class="p">);</span>

  <span class="c1">// Wait for the thread to terminate.</span>
  <span class="n">th</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>

  <span class="c1">// ...</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>A similar example, but written in C:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">/// @file app-main.c</span>
<span class="cp">#include &lt;cmsis-plus/rtos/os-c-api.h&gt;
</span>
<span class="c1">// Thread function.</span>
<span class="kt">void</span><span class="o">*</span>
<span class="nf">th_func</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// Wait for two event flags.</span>
  <span class="c1">// In C there are no defaults, all parameters must be specified.</span>
  <span class="n">os_result_t</span> <span class="n">res</span><span class="p">;</span>
  <span class="n">res</span> <span class="o">=</span> <span class="n">os_this_thread_flags_timed_wait</span><span class="p">(</span><span class="mh">0x3</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">os_flags_mode_all</span> <span class="o">|</span> <span class="n">os_flags_mode_clear</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">os_ok</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">trace_printf</span><span class="p">(</span><span class="s">"Both flags raised</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">ETIMEDOUT</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">trace_printf</span><span class="p">(</span><span class="s">"Timeout</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">os_main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="c1">// ...</span>

  <span class="c1">// Local storage for the thread object.</span>
  <span class="n">os_thread_t</span> <span class="n">th</span><span class="p">;</span>

  <span class="c1">// Initialise the thread object and allocate the thread stack.</span>
  <span class="n">os_thread_construct</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="s">"th"</span><span class="p">,</span> <span class="n">th_func</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="c1">// Raise one flag. The condition is not enough to resume the thread.</span>
  <span class="n">os_thread_flags_raise</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>

  <span class="c1">// Pretend the thread has something important to do.</span>
  <span class="n">os_sysclock_sleep_for</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

  <span class="c1">// Raise second flag. The thread will be resumed.</span>
  <span class="n">os_thread_flags_raise</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">);</span>

  <span class="c1">// Wait for the thread to terminate.</span>
  <span class="n">os_thread_join</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="c1">// ...</span>

  <span class="c1">// For completeness, destroy the thread.</span>
  <span class="n">os_thread_destruct</span><span class="p">(</span><span class="o">&amp;</span><span class="n">th</span><span class="p">);</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To check if any flag in the set is raised, use <code class="language-plaintext highlighter-rouge">flags::mode::any</code> (in C use <code class="language-plaintext highlighter-rouge">os_flags_mode_any</code>).</p>

<h2 id="other-thread-event-flags-functions">Other thread event flags functions</h2>

<p>As presented in the above example, the common use case of the thread event flags is to automatically clear the raised flags after testing. For special cases it might be useful to individually read and clear each flag.</p>

<h3 id="getting-individual-flags">Getting individual flags</h3>

<p>It is possible for one thread to selectively read its own flags, and possibly clear them afterwards. To prevent clearing, pass a 0 mode value.</p>

<p>Only the flags present in the mask are affected.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">flags</span><span class="o">::</span><span class="n">mask_t</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">this_thread</span><span class="o">::</span><span class="n">flags_get</span><span class="p">(</span><span class="mh">0x2</span><span class="p">,</span> <span class="n">flags</span><span class="o">::</span><span class="n">mode</span><span class="o">::</span><span class="n">clear</span><span class="p">);</span>
</code></pre></div></div>

<p>A similar example, but written in C:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">os_flags_mask_t</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">os_this_thread_flags_get</span><span class="p">(</span><span class="mh">0x2</span><span class="p">,</span> <span class="n">os_flags_mode_clear</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="clearing-individual-flags">Clearing individual flags</h3>

<p>It is possible for one thread to selectively clear its own flags, and possibly get the value of the flags before clearing. If the passed pointer is null, the previous values of the selected flags are
lost.</p>

<p>Only the flags present in the mask are affected.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">flags</span><span class="o">::</span><span class="n">mask_t</span> <span class="n">mask</span><span class="p">;</span>
<span class="n">this_thread</span><span class="o">::</span><span class="n">flags_clear</span><span class="p">(</span><span class="mh">0x2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mask</span><span class="p">);</span>
</code></pre></div></div>

<p>A similar example, but written in C:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">os_flags_mask_t</span> <span class="n">mask</span><span class="p">;</span>
<span class="n">os_this_thread_flags_clear</span><span class="p">(</span><span class="mh">0x2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mask</span><span class="p">);</span>
</code></pre></div></div>








<ul class="share-buttons">
  <li><div class="tw-share-button"><a href="https://twitter.com/share" class="twitter-share-button" data-count="none">Tweet</a></div></li>
  <li><div class="fb-share-button" data-href="http://micro-os-plus.github.io/user-manual/thread-event-flags/" data-layout="button"></div></li>
</ul>



      </div>

    </div>
  </div>

</div>

<div class="container">

  <div class="site-footer">
  <div class="site-footer-links left">
    <ul>
  <li>© 2023 Liviu Ionescu</li>
  <li>Hosted on GitHub</li>
  <li><a href="/feed.xml"><img src="/assets/images/feed-20.png" alt="RSS"></a></li>
  <li>
<a href="http://twitter.com/micro_os_plus" class="twitter-follow-button" data-show-count="false">Follow @micro_os_plus</a><script async="" src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
</li>
</ul>


  </div>
  <a href="https://github.com/micro-os-plus/micro-os-plus-iii" aria-label="Homepage">
      <span class="mega-octicon octicon-mark-github" title="GitHub"></span>
  </a>
  <div class="site-footer-links right">
    <ul>
  <li><a href="/">Home</a></li>
  <li><a href="/blog/">News</a></li>
  <li><a href="https://github.com/micro-os-plus/micro-os-plus-iii/releases">Releases</a></li>
  <li><a href="https://github.com/micro-os-plus/micro-os-plus-iii/issues">Support</a></li>
  <li><a href="/about/">About</a></li>
</ul>

  </div>
</div>


</div>

</body>
</html>
